<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Impression Verification | Cybertect</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/assets/internal-base.css">
    <style>
        main { max-width: 1200px; margin: 0 auto; padding: 60px 24px 120px; }
        .tool-hero { text-align: left; margin-bottom: 32px; }
        .eyebrow { text-transform: uppercase; letter-spacing: 2px; font-size: 12px; color: var(--text-gray); margin-bottom: 12px; }
        h1 { font-size: 40px; margin-bottom: 12px; color: var(--text-dark); }
        .subtitle { font-size: 18px; color: var(--text-gray); max-width: 720px; }
        .panel {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 12px 30px rgba(15,23,42,0.08);
        }
        .panel h2 { font-size: 20px; margin-bottom: 16px; color: var(--text-dark); }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--blue);
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-group .helper {
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 4px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .run-btn {
            background: var(--blue);
            color: var(--white);
            padding: 14px 32px;
            border-radius: 999px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 16px;
        }
        .run-btn:hover { background: var(--blue-dark); }
        .run-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .run-btn.loading {
            opacity: 0.7;
            cursor: wait;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .summary-card {
            background: var(--light-gray);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .summary-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 4px;
        }
        .summary-card .label {
            font-size: 13px;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .summary-card.warning .value { color: var(--yellow); }
        .summary-card.error .value { color: var(--red); }
        .summary-card.success .value { color: var(--green); }
        .timeline-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        .timeline-table th,
        .timeline-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        .timeline-table th {
            background: var(--light-gray);
            font-weight: 600;
            color: var(--text-dark);
            cursor: pointer;
            user-select: none;
        }
        .timeline-table th:hover {
            background: #E2E8F0;
        }
        .timeline-table th.sort-asc::after { content: ' ‚ñ≤'; }
        .timeline-table th.sort-desc::after { content: ' ‚ñº'; }
        .timeline-table td {
            color: var(--text-gray);
        }
        .timeline-table tr:hover {
            background: var(--light-gray);
        }
        .type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .type-badge.impression-beacon { background: #DBEAFE; color: #1E40AF; }
        .type-badge.click-redirect { background: #FEF3C7; color: #92400E; }
        .type-badge.gpt-viewable { background: #D1FAE5; color: #065F46; }
        .type-badge.gpt-slot-render { background: #E0E7FF; color: #4338CA; }
        .type-badge.tag-library { background: #F3F4F6; color: #6B7280; }
        .type-badge.id-sync { background: #FCE7F3; color: #9F1239; }
        .type-badge.ad-request { background: #FEF3C7; color: #92400E; }
        .type-badge.gam-ad-request { background: #E0E7FF; color: #4338CA; }
        .type-badge.viewability { background: #D1FAE5; color: #065F46; }
        .type-badge.other { background: #F3F4F6; color: #6B7280; }
        .type-badge.suspect-click { background: #FEE2E2; color: #991B1B; }
        .flags-panel {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
        }
        .flags-panel h3 {
            font-size: 16px;
            color: var(--red);
            margin-bottom: 12px;
        }
        .flag-item {
            padding: 12px;
            background: var(--white);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--red);
        }
        .flag-item:last-child { margin-bottom: 0; }
        .flag-item .creative-id {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }
        .flag-item .message {
            font-size: 13px;
            color: var(--text-gray);
        }
        .export-btn {
            background: var(--green);
            color: var(--white);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            margin-top: 16px;
            transition: background 0.2s;
        }
        .export-btn:hover { background: #059669; }
        .export-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .hidden { display: none; }
        .error-message {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            color: var(--red);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        @media (max-width: 640px) {
            .header { flex-direction: column; align-items: flex-start; }
            .top-menu { margin: 12px 0; width: 100%; justify-content: flex-start; }
            .dropdown { width: 100%; }
            .dropdown-toggle { width: 100%; justify-content: space-between; }
            .dropdown-menu { position: static; box-shadow: none; margin-top: 8px; width: 100%; }
            .logo-container { font-size: 24px; }
            .form-row { grid-template-columns: 1fr; }
            .summary-cards { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-container">
            <a href="/" class="cybertect-logo" aria-label="Cybertect home">
                <span class="cyber-text">cyber</span><span class="tect-text">tect</span><span class="com-text">.com</span>
            </a>
        </div>
        <nav class="top-menu">
            <a class="nav-pill nav-pill-link" href="/online-waste/" data-route="/online-waste">Online Waste</a>
            <div class="dropdown" data-dropdown>
                <button class="dropdown-toggle nav-pill" type="button" aria-haspopup="true" aria-expanded="false">
                    Waste Detection Tools
                    <span class="material-icons" aria-hidden="true">expand_more</span>
                </button>
                <div class="dropdown-menu" role="menu">
                    <a class="tool-link" href="/tools/cms-level-data-monitor/" data-route="/tools/cms-level-data-monitor">CMS Output Monitor</a>
                    <a class="tool-link" href="/tools/ad-level-impression-verification/" data-route="/tools/ad-level-impression-verification">Ad Impression Verification</a>
                    <a class="tool-link" href="/tools/analytics-integrity-diagnosis/" data-route="/tools/analytics-integrity-diagnosis">Analytics Integrity Diagnosis</a>
                    <a class="tool-link" href="/tools/injected-telemetry-monitor/" data-route="/tools/injected-telemetry-monitor">Injected Telemetry Monitor</a>
                    <a class="tool-link" href="/tools/reverse-analytics-search/" data-route="/tools/reverse-analytics-search">Reverse Analytics Search</a>
                </div>
            </div>
        </nav>
        <button class="sign-in-btn">Sign in</button>
    </header>

    <main>
        <div class="tool-hero">
            <p class="eyebrow">Cybertect Toolbox</p>
            <h1>Ad Impression Verification</h1>
            <p class="subtitle">Trace impressions ‚Üí verify viewability ‚Üí reconcile delivery ‚Üí export evidence.</p>
        </div>

        <!-- Input Form -->
        <section class="panel" id="input-panel">
            <h2>Scan Configuration</h2>
            <form id="scan-form">
                <div class="form-group">
                    <label for="url">Website URL <span style="color: var(--red);">*</span></label>
                    <input type="url" id="url" name="url" required placeholder="https://example.com" />
                </div>

                <div class="form-group">
                    <label for="campaign-label">Campaign / Placement Label (Optional)</label>
                    <input type="text" id="campaign-label" name="campaign-label" placeholder="Campaign Name" />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="viewability-rule">Viewability Threshold</label>
                        <select id="viewability-rule" name="viewability-rule">
                            <option value="50%/1s" selected>50% / 1s (Default)</option>
                            <option value="50%/2s">50% / 2s</option>
                            <option value="100%/1s">100% / 1s</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="discrepancy-threshold">Discrepancy Threshold (%)</label>
                        <input type="number" id="discrepancy-threshold" name="discrepancy-threshold" value="10" min="0" max="100" />
                        <p class="helper">Flag campaigns where viewability gap exceeds this percentage</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="delivery-totals">Upload Delivery Totals (Optional)</label>
                    <textarea id="delivery-totals" name="delivery-totals" placeholder='Paste JSON: {"adserverImps": 1000, "dspImps": 950, "clicks": 50}&#10;Or CSV: adserverImps,dspImps,clicks&#10;1000,950,50'></textarea>
                    <p class="helper">Provide ad-server/DSP delivery totals for reconciliation</p>
                </div>

                <div class="form-group">
                    <button type="submit" class="run-btn" id="run-btn">Run Scan</button>
                </div>
            </form>

            <div id="error-message" class="error-message hidden"></div>
        </section>

        <!-- Results Section -->
        <section class="panel hidden" id="results-panel">
            <h2>Scan Results</h2>

            <!-- Summary Cards -->
            <div class="summary-cards" id="summary-cards"></div>

            <!-- Timeline Table -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="font-size: 18px; margin: 0;">Beacon Sequence</h3>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: var(--text-gray);">
                        <input type="checkbox" id="show-diagnostic-toggle" style="cursor: pointer;" />
                        <span>Show diagnostic</span>
                    </label>
                </div>
                <table class="timeline-table" id="timeline-table">
                    <thead>
                        <tr>
                            <th data-sort="ts">Timestamp</th>
                            <th data-sort="type">Type</th>
                            <th data-sort="vendor">Vendor</th>
                            <th data-sort="creativeId">Creative ID</th>
                            <th data-sort="placement">Placement</th>
                            <th data-sort="status">Status</th>
                            <th>URL</th>
                        </tr>
                    </thead>
                    <tbody id="timeline-body"></tbody>
                </table>
            </div>

            <!-- Flags Panel -->
            <div id="flags-container"></div>

            <!-- Ad Stacking Findings Panel -->
            <div id="ad-stacking-container"></div>

            <!-- Export + AI Validation -->
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="export-btn" id="export-btn" disabled>Export Evidence Pack</button>
                <button class="export-btn" id="ai-validate-btn" style="background:#2563EB" disabled>AI Validate</button>
            </div>
        </section>
    </main>

    <script>
        let currentRunId = null;
        let currentSequences = [];
        let currentResult = null;
        let sortColumn = null;
        let sortDirection = 'asc';
        let showDiagnostic = false; // Default: hide diagnostic events

        function setActiveNav() {
            const current = window.location.pathname.replace(/\/$/, '');
            document.querySelectorAll('[data-route]').forEach(link => {
                const route = (link.dataset.route || '').replace(/\/$/, '');
                if (route && route === current) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        function initDropdowns() {
            const dropdowns = document.querySelectorAll('[data-dropdown]');
            if (!dropdowns.length) return;

            const closeAll = () => {
                dropdowns.forEach(dropdown => {
                    const menu = dropdown.querySelector('.dropdown-menu');
                    const toggle = dropdown.querySelector('.dropdown-toggle');
                    if (menu) menu.classList.remove('show');
                    if (toggle) toggle.setAttribute('aria-expanded', 'false');
                });
            };

            dropdowns.forEach(dropdown => {
                const toggle = dropdown.querySelector('.dropdown-toggle');
                const menu = dropdown.querySelector('.dropdown-menu');
                if (!toggle || !menu) return;
                toggle.addEventListener('click', event => {
                    event.preventDefault();
                    event.stopPropagation();
                    const isOpen = menu.classList.toggle('show');
                    toggle.setAttribute('aria-expanded', String(isOpen));
                    if (isOpen) {
                        dropdowns.forEach(other => {
                            if (other === dropdown) return;
                            const otherMenu = other.querySelector('.dropdown-menu');
                            const otherToggle = other.querySelector('.dropdown-toggle');
                            if (otherMenu) otherMenu.classList.remove('show');
                            if (otherToggle) otherToggle.setAttribute('aria-expanded', 'false');
                        });
                    }
                });
            });

            document.addEventListener('click', event => {
                const target = event.target;
                if (!(target instanceof Element)) return;
                if (!target.closest('[data-dropdown]')) {
                    closeAll();
                }
            });

            document.addEventListener('keyup', event => {
                if (event.key === 'Escape') {
                    closeAll();
                }
            });
        }

        document.getElementById('scan-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const url = document.getElementById('url').value;
            const campaignLabel = document.getElementById('campaign-label').value;
            const viewabilityRule = document.getElementById('viewability-rule').value;
            const discrepancyThreshold = parseFloat(document.getElementById('discrepancy-threshold').value);
            const deliveryTotals = document.getElementById('delivery-totals').value.trim();

            const runBtn = document.getElementById('run-btn');
            const errorMsg = document.getElementById('error-message');
            
            runBtn.disabled = true;
            runBtn.classList.add('loading');
            runBtn.textContent = 'Scanning...';
            errorMsg.classList.add('hidden');

            try {
                const response = await fetch('http://localhost:3000/api/ad-impression-verification/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url,
                        campaignLabel: campaignLabel || null,
                        viewabilityRule,
                        discrepancyThreshold,
                        deliveryTotals: deliveryTotals || null
                    })
                });

                const result = await response.json();

                if (result.error) {
                    throw new Error(result.error);
                }

                currentRunId = result.runId;
                currentSequences = result.sequences || [];
                
                displayResults(result);
                document.getElementById('results-panel').classList.remove('hidden');
                document.getElementById('export-btn').disabled = false;

            } catch (error) {
                errorMsg.textContent = `Scan failed: ${error.message}`;
                errorMsg.classList.remove('hidden');
            } finally {
                runBtn.disabled = false;
                runBtn.classList.remove('loading');
                runBtn.textContent = 'Run Scan';
            }
        });

        function displayResults(result) {
            const summary = result.summary || {};
            const diagnostic = summary.diagnostic || {};
            currentResult = result;
            const aiBtn = document.getElementById('ai-validate-btn');
            if (aiBtn) aiBtn.disabled = false;
            
            // Calculate if we have GPT data for viewability
            const hasViewabilityData = summary.viewableImpressions > 0 || summary.totalImpressions > 0;
            const discrepancyDisplay = summary.discrepancyPercent !== null && summary.discrepancyPercent !== undefined 
                ? summary.discrepancyPercent + '%' 
                : 'N/A';
            const discrepancyClass = summary.discrepancyPercent !== null && summary.discrepancyPercent > 10 
                ? 'error' 
                : (summary.discrepancyPercent !== null ? 'success' : '');
            
            // Update summary cards
            const cardsHtml = `
                <div class="summary-card">
                    <div class="value">${summary.servedImpressions || 0}</div>
                    <div class="label">Served Impressions</div>
                </div>
                <div class="summary-card">
                    <div class="value">${summary.verifiedImpressions || 0}</div>
                    <div class="label">Verified Impressions</div>
                </div>
                <div class="summary-card ${hasViewabilityData && (summary.viewableImpressions || 0) < (summary.totalImpressions || 0) ? 'warning' : 'success'}">
                    <div class="value">${summary.viewableImpressions !== null && summary.viewableImpressions !== undefined ? summary.viewableImpressions : 'N/A'}</div>
                    <div class="label">Viewable Verified</div>
                </div>
                <div class="summary-card">
                    <div class="value">${summary.clicks || 0}</div>
                    <div class="label">Clicks</div>
                </div>
                <div class="summary-card ${discrepancyClass}">
                    <div class="value">${discrepancyDisplay}</div>
                    <div class="label">Discrepancy</div>
                </div>
                ${diagnostic.tagLibraryLoads !== undefined ? `
                <div class="summary-card">
                    <div class="value">${diagnostic.tagLibraryLoads || 0}</div>
                    <div class="label">Tag Library Loads</div>
                </div>
                ` : ''}
                ${diagnostic.idSyncCount !== undefined ? `
                <div class="summary-card">
                    <div class="value">${diagnostic.idSyncCount || 0}</div>
                    <div class="label">ID Sync Events</div>
                </div>
                ` : ''}
                ${diagnostic.adRequests !== undefined ? `
                <div class="summary-card">
                    <div class="value">${diagnostic.adRequests || 0}</div>
                    <div class="label">Ad Requests</div>
                </div>
                ` : ''}
                ${diagnostic.gamAdRequests !== undefined ? `
                <div class="summary-card">
                    <div class="value">${diagnostic.gamAdRequests || 0}</div>
                    <div class="label">GAM Ad Requests</div>
                </div>
                ` : ''}
                ${diagnostic.unattributedBeacons !== undefined ? `
                <div class="summary-card">
                    <div class="value">${diagnostic.unattributedBeacons || 0}</div>
                    <div class="label">Unattributed Beacons</div>
                </div>
                ` : ''}
            `;
            document.getElementById('summary-cards').innerHTML = cardsHtml;

            // Update timeline table
            renderTimeline(currentSequences);

            // Update flags
            const flags = result.flags || [];
            if (flags.length > 0) {
                const flagsHtml = `
                    <div class="flags-panel">
                        <h3>‚ö†Ô∏è Flags (${flags.length})</h3>
                        ${flags.map(flag => `
                            <div class="flag-item">
                                <div class="creative-id">Creative: ${flag.creativeId} | Placement: ${flag.placement}</div>
                                <div class="message">${flag.message}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                document.getElementById('flags-container').innerHTML = flagsHtml;
            } else {
                document.getElementById('flags-container').innerHTML = '';
            }
            
            // Update ad stacking findings
            const adStacking = result.adStackingFindings || summary.adStackingFindings;
            if (adStacking && (adStacking.stackedPairsCount > 0 || adStacking.hiddenIframesCount > 0 || adStacking.tinyIframesCount > 0 || adStacking.offscreenIframesCount > 0)) {
                const adStackingHtml = `
                    <div class="flags-panel" style="background: #FEF3C7; border-color: #FCD34D;">
                        <h3 style="color: #92400E;">üîç Ad Stacking Findings</h3>
                        <div style="margin-bottom: 12px;">
                            <strong>Stacked Pairs:</strong> ${adStacking.stackedPairsCount || 0} | 
                            <strong>Hidden Iframes:</strong> ${adStacking.hiddenIframesCount || 0} | 
                            <strong>Tiny Iframes:</strong> ${adStacking.tinyIframesCount || 0} | 
                            <strong>Offscreen Iframes:</strong> ${adStacking.offscreenIframesCount || 0}
                        </div>
                        ${adStacking.findings && adStacking.findings.length > 0 ? `
                            <div style="font-size: 13px; color: #78350F;">
                                <strong>Details:</strong> Check adstack_report.json in evidence pack for screenshots and full details.
                            </div>
                        ` : ''}
                    </div>
                `;
                document.getElementById('ad-stacking-container').innerHTML = adStackingHtml;
            } else {
                document.getElementById('ad-stacking-container').innerHTML = '';
            }
        }

        function renderTimeline(sequences) {
            const tbody = document.getElementById('timeline-body');
            
            // Filter diagnostic events based on toggle state
            let displaySequences;
            if (showDiagnostic) {
                // Show all events including diagnostic
                displaySequences = sequences;
            } else {
                // Hide diagnostic events (TAG_LIBRARY, ID_SYNC, AD_REQUEST, GAM_AD_REQUEST, OTHER)
                displaySequences = sequences.filter(seq => 
                    seq.type !== 'TAG_LIBRARY' && 
                    seq.type !== 'ID_SYNC' &&
                    seq.type !== 'AD_REQUEST' && 
                    seq.type !== 'GAM_AD_REQUEST' &&
                    seq.type !== 'OTHER'
                );
            }
            
            if (displaySequences.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-gray);">No beacons detected</td></tr>';
                return;
            }

            tbody.innerHTML = displaySequences.map(seq => {
                const date = new Date(seq.ts);
                const timeStr = date.toLocaleTimeString() + '.' + date.getMilliseconds().toString().padStart(3, '0');
                const urlDisplay = seq.requestUrl && seq.requestUrl.length > 60 
                    ? seq.requestUrl.substring(0, 60) + '...' 
                    : (seq.requestUrl || 'N/A');
                
                // Map event types to CSS classes
                const badgeClass = getBadgeClass(seq.type);
                const typeDisplay = formatEventType(seq.type);
                
                return `
                    <tr>
                        <td>${timeStr}</td>
                        <td><span class="type-badge ${badgeClass}">${typeDisplay}</span></td>
                        <td>${seq.vendor || 'Unknown'}</td>
                        <td>${seq.creativeId || 'N/A'}</td>
                        <td>${seq.placement || 'N/A'}</td>
                        <td>${seq.status || 'N/A'}</td>
                        <td title="${seq.requestUrl || ''}">${urlDisplay}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function getBadgeClass(type) {
            const classMap = {
                'IMPRESSION_BEACON': 'impression-beacon',
                'CLICK_REDIRECT': 'click-redirect',
                'GPT_VIEWABLE': 'gpt-viewable',
                'GPT_SLOT_RENDER': 'gpt-slot-render',
                'TAG_LIBRARY': 'tag-library',
                'ID_SYNC': 'id-sync',
                'AD_REQUEST': 'ad-request',
                'GAM_AD_REQUEST': 'gam-ad-request',
                'VIEWABILITY': 'viewability',
                'OTHER': 'other',
                'SUSPECT_CLICK': 'suspect-click'
            };
            return classMap[type] || 'other';
        }
        
        function formatEventType(type) {
            const displayMap = {
                'IMPRESSION_BEACON': 'Impression',
                'CLICK_REDIRECT': 'Click',
                'GPT_VIEWABLE': 'Viewable',
                'GPT_SLOT_RENDER': 'GPT Render',
                'TAG_LIBRARY': 'Tag Library',
                'ID_SYNC': 'ID Sync',
                'AD_REQUEST': 'Ad Request',
                'GAM_AD_REQUEST': 'GAM Ad Request',
                'VIEWABILITY': 'Viewability',
                'OTHER': 'Other',
                'SUSPECT_CLICK': 'Suspect Click'
            };
            return displayMap[type] || type;
        }

        // Table sorting
        document.querySelectorAll('#timeline-table th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;
                
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }

                // Update UI
                document.querySelectorAll('#timeline-table th').forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');

                // Sort sequences
                currentSequences.sort((a, b) => {
                    let aVal = a[column];
                    let bVal = b[column];
                    
                    if (column === 'ts') {
                        aVal = a.ts;
                        bVal = b.ts;
                    }
                    
                    if (aVal === null || aVal === undefined) return 1;
                    if (bVal === null || bVal === undefined) return -1;
                    
                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }
                    
                    if (sortDirection === 'asc') {
                        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                    } else {
                        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                    }
                });

                renderTimeline(currentSequences);
            });
        });

        async function buildAdEvidencePack() {
            if (!currentResult) {
                throw new Error('Run a scan before validating.');
            }
            const summary = currentResult.summary || {};
            const targetUrl = summary.url || document.getElementById('url').value || '';
            let domain = '';
            try { domain = new URL(targetUrl).hostname; } catch (e) {}
            const findings = [];
            if (summary.discrepancyPercent !== undefined) {
                findings.push({
                    type: 'impression_discrepancy',
                    severity: summary.discrepancyPercent > 20 ? 'high' : 'med',
                    description: `Discrepancy ${summary.discrepancyPercent}% between served and verified`,
                    evidence: [
                        { kind: 'metric', name: 'totalImpressions', value: summary.summary?.totalImpressions },
                        { kind: 'metric', name: 'viewableImpressions', value: summary.summary?.viewableImpressions }
                    ]
                });
            }
            const artifacts = [];
            if (currentRunId) {
                artifacts.push({
                    kind: 'zip',
                    name: `evidence-pack-${currentRunId}.zip`,
                    uri: `/api/ad-impression-verification/export?runId=${currentRunId}`
                });
            }
            return {
                version: '1.0',
                createdAt: new Date().toISOString(),
                target: { url: targetUrl, domain },
                findings,
                telemetry: { summary },
                artifacts
            };
        }

        async function mockValidate(payload) {
            await new Promise(res => setTimeout(res, 500));
            return {
                status: 'done',
                result: {
                    verdict: 'likely_inflation',
                    confidence: 0.72,
                    key_findings: [
                        {
                            title: 'Mock stacked iframes',
                            detail: 'Simulated inflation signal for demo',
                            confidence: 0.8,
                            evidence_refs: ['artifact:mock']
                        }
                    ],
                    duplicate_assessment: { has_duplicates: true, likely_tool_error: false, notes: 'mock' },
                    inflation_signals: [{ signal: 'Beacon > render', strength: 'strong', evidence_refs: ['log:mock'] }],
                    recommended_actions: ['Review placements', 'Reconcile with ad server'],
                    missing_data_requests: []
                }
            };
        }

        function renderMockVerdict(result) {
            const panelId = 'ai-validation-panel';
            let panel = document.getElementById(panelId);
            if (!panel) {
                panel = document.createElement('div');
                panel.id = panelId;
                panel.style.marginTop = '12px';
                document.getElementById('results-panel')?.appendChild(panel);
            }
            const verdict = result?.verdict || 'inconclusive';
            const confidence = result?.confidence != null ? Math.round(result.confidence * 100) + '%' : '‚Äî';
            const findings = result?.key_findings || [];
            const color = verdict === 'verified' ? '#0f766e'
                        : verdict === 'likely_inflation' ? '#b91c1c'
                        : verdict === 'inconclusive' ? '#92400e'
                        : '#4b5563';

            panel.style.display = 'block';
            panel.style.border = `1px solid ${color}33`;
            panel.style.background = '#f8fafc';
            panel.style.borderRadius = '12px';
            panel.style.padding = '12px';
            panel.style.color = '#0f172a';
            panel.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                  <div style="font-weight:700;color:${color}">Verdict: ${verdict}</div>
                  <div style="font-size:12px;color:#475569;">Confidence: ${confidence}</div>
                </div>
                <div style="font-size:13px;color:#475569;margin-bottom:6px;">Key Findings</div>
                <div style="display:flex;flex-direction:column;gap:6px;">
                  ${findings.map((f) => `
                    <div style="padding:8px;border:1px solid #e2e8f0;border-radius:10px;background:#fff;">
                      <div style="font-weight:600;color:#0f172a;">${f.title || 'Finding'}</div>
                      <div style="font-size:13px;color:#475569;margin-top:4px;">${f.detail || ''}</div>
                      <div style="font-size:12px;color:#94a3b8;margin-top:4px;">Conf: ${Math.round((f.confidence||0)*100)}%</div>
                    </div>
                  `).join('')}
                </div>
            `;
        }

        document.getElementById('ai-validate-btn').addEventListener('click', async () => {
            const btn = document.getElementById('ai-validate-btn');
            if (!currentResult) {
                alert('Run a scan before AI validation.');
                return;
            }
            btn.disabled = true;
            btn.textContent = 'Sending...';
            try {
                const evidencePack = await buildAdEvidencePack();
                const { result } = await mockValidate({ evidencePack });
                renderMockVerdict(result);
                btn.textContent = 'AI Validate';
                btn.disabled = false;
            } catch (error) {
                alert(`AI validation failed: ${error.message}`);
                btn.textContent = 'AI Validate';
                btn.disabled = false;
            }
        });

        // Export button
        document.getElementById('export-btn').addEventListener('click', async () => {
            if (!currentRunId) return;

            const exportBtn = document.getElementById('export-btn');
            exportBtn.disabled = true;
            exportBtn.textContent = 'Generating...';

            try {
                const response = await fetch(`http://localhost:3000/api/ad-impression-verification/export?runId=${currentRunId}`);
                
                if (!response.ok) {
                    throw new Error('Export failed');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `evidence-pack-${currentRunId}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                exportBtn.textContent = 'Export Evidence Pack';
            } catch (error) {
                alert(`Export failed: ${error.message}`);
                exportBtn.textContent = 'Export Evidence Pack';
            } finally {
                exportBtn.disabled = false;
            }
        });

        // Toggle diagnostic events visibility
        document.getElementById('show-diagnostic-toggle').addEventListener('change', (e) => {
            showDiagnostic = e.target.checked;
            renderTimeline(currentSequences);
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            setActiveNav();
            initDropdowns();
        });
    </script>

    <footer class="footer">
        <div class="footer-content">
            <p class="footer-disclaimer">
                <strong>Disclaimer:</strong> The results provided by this tool are for informational purposes only. Cybertect does not guarantee the accuracy, completeness, or reliability of scan results. Results may contain false positives or false negatives. Users should verify findings independently before making business decisions. Cybertect is not liable for any decisions made based on these results.
            </p>
            <div class="footer-links">
                <a href="/terms-of-service.html">Terms of Service</a>
                <span class="footer-separator">|</span>
                <a href="/privacy-policy.html">Privacy Policy</a>
            </div>
            <p class="footer-copyright">¬© 2025 Cybertect. All rights reserved.</p>
        </div>
    </footer>
</body>
</html>
